# Makefile para DFA Paralelo MPI - VersiÃ³n Simplificada
CXX = mpic++
CXXFLAGS = -std=c++17 -O3 -Wall -Wextra -Wno-cast-function-type
TARGET_ORIGINAL = dfa_parallel
TARGET_OPTIMIZED = dfa_optimized
TARGET_METRICS = scalability_metrics

# NÃºmero de procesos por defecto
NP ?= 4

# Archivos compartidos (sin main)
SHARED_SOURCES = parallel_dfa.cpp communication_tests.cpp dfa_tests.cpp utils.cpp optimized_parallel_dfa.cpp

# Archivos especÃ­ficos por versiÃ³n
MAIN_ORIGINAL = main.cpp
MAIN_OPTIMIZED = optimized_main.cpp
MAIN_METRICS = scalability_metrics.cpp

# Fuentes completas por versiÃ³n
SOURCES_ORIGINAL = $(MAIN_ORIGINAL) $(SHARED_SOURCES)
SOURCES_OPTIMIZED = $(MAIN_OPTIMIZED) $(SHARED_SOURCES)
SOURCES_METRICS = $(MAIN_METRICS) optimized_parallel_dfa.cpp utils.cpp

# Objetivos principales
all: $(TARGET_ORIGINAL) $(TARGET_OPTIMIZED) $(TARGET_METRICS)

# VersiÃ³n original (usa main.cpp como punto de entrada)
$(TARGET_ORIGINAL): $(SOURCES_ORIGINAL)
	@echo "ğŸ”¨ Compilando versiÃ³n original..."
	$(CXX) $(CXXFLAGS) $(SOURCES_ORIGINAL) -o $(TARGET_ORIGINAL)
	@echo "âœ… VersiÃ³n original compilada: $(TARGET_ORIGINAL)"

# VersiÃ³n optimizada (usa optimized_main.cpp como punto de entrada)
$(TARGET_OPTIMIZED): $(SOURCES_OPTIMIZED)
	@echo "ğŸ”¨ Compilando versiÃ³n optimizada..."
	$(CXX) $(CXXFLAGS) $(SOURCES_OPTIMIZED) -o $(TARGET_OPTIMIZED)
	@echo "âœ… VersiÃ³n optimizada compilada: $(TARGET_OPTIMIZED)"

# Compilar solo la versiÃ³n original
original: $(TARGET_ORIGINAL)

# Compilar solo la versiÃ³n optimizada  
optimized: $(TARGET_OPTIMIZED)

# Compilar mÃ©tricas de escalabilidad
$(TARGET_METRICS): $(SOURCES_METRICS)
	@echo "ğŸ“Š Compilando generador de mÃ©tricas de escalabilidad..."
	$(CXX) $(CXXFLAGS) $(SOURCES_METRICS) -o $(TARGET_METRICS)
	@echo "âœ… Generador de mÃ©tricas compilado: $(TARGET_METRICS)"

# Compilar solo las mÃ©tricas
metrics: $(TARGET_METRICS)

# Verificar archivos fuente
check-sources:
	@echo "ğŸ“‚ Archivos para versiÃ³n original:"
	@echo "$(SOURCES_ORIGINAL)"
	@echo ""
	@echo "ğŸ“‚ Archivos para versiÃ³n optimizada:"
	@echo "$(SOURCES_OPTIMIZED)"
	@echo ""
	@echo "ğŸ” Verificando existencia de archivos..."
	@for file in $(SOURCES_ORIGINAL); do \
		if [ -f $$file ]; then \
			echo "âœ… $$file"; \
		else \
			echo "âŒ $$file (NO ENCONTRADO)"; \
		fi \
	done

# Limpiar
clean:
	@echo "ğŸ§¹ Limpiando archivos compilados y resultados..."
	rm -f $(TARGET_ORIGINAL) $(TARGET_OPTIMIZED) $(TARGET_METRICS)
	rm -rf resultados_mpi/
	rm -f MetricsGraphics.txt
	@echo "âœ… Limpieza completada"

# Ejecutar versiÃ³n original
run-original: $(TARGET_ORIGINAL)
	@echo "ğŸ”„ Ejecutando versiÃ³n original con $(NP) procesos..."
	mpirun -np $(NP) ./$(TARGET_ORIGINAL)

# Ejecutar versiÃ³n optimizada
run-optimized: $(TARGET_OPTIMIZED)
	@echo "âš¡ Ejecutando versiÃ³n optimizada con $(NP) procesos..."
	mpirun -np $(NP) ./$(TARGET_OPTIMIZED)

# Comparar ambas versiones
compare: $(TARGET_ORIGINAL) $(TARGET_OPTIMIZED)
	@echo "âš–ï¸ Comparando versiones con $(NP) procesos..."
	@echo "ğŸ”„ VersiÃ³n original:"
	mpirun -np $(NP) ./$(TARGET_ORIGINAL)
	@echo ""
	@echo "âš¡ VersiÃ³n optimizada:"
	mpirun -np $(NP) ./$(TARGET_OPTIMIZED)

# Generar mÃ©tricas individuales por nÃºmero de procesos
generate-metrics-p1: scalability_metrics
	@echo "ğŸ“ˆ Generando mÃ©tricas para P = 1..."
	mpirun -np 1 ./scalability_metrics 1
	@echo "âœ… MÃ©tricas P=1 completadas"

generate-metrics-p2: scalability_metrics
	@echo "ğŸ“ˆ Generando mÃ©tricas para P = 2..."
	mpirun -np 2 ./scalability_metrics 2
	@echo "âœ… MÃ©tricas P=2 completadas"

generate-metrics-p4: scalability_metrics
	@echo "ğŸ“ˆ Generando mÃ©tricas para P = 4..."
	mpirun -np 4 ./scalability_metrics 4
	@echo "âœ… MÃ©tricas P=4 completadas"

generate-metrics-p8: scalability_metrics
	@echo "ğŸ“ˆ Generando mÃ©tricas para P = 8..."
	mpirun -np 8 ./scalability_metrics 8
	@echo "âœ… MÃ©tricas P=8 completadas"

generate-metrics-p16: scalability_metrics
	@echo "ğŸ“ˆ Generando mÃ©tricas para P = 16..."
	mpirun -np 16 ./scalability_metrics 16
	@echo "âœ… MÃ©tricas P=16 completadas"

generate-metrics-p32: scalability_metrics
	@echo "ğŸ“ˆ Generando mÃ©tricas para P = 32..."
	mpirun -np 32 ./scalability_metrics 32
	@echo "âœ… MÃ©tricas P=32 completadas"

# Generar todas las mÃ©tricas secuencialmente
generate-all-metrics: scalability_metrics
	@echo "ğŸš€ Iniciando generaciÃ³n completa de mÃ©tricas de escalabilidad..."
	@echo "ğŸ“‹ Se generarÃ¡n mÃ©tricas para P = 1, 2, 4, 8, 16, 32"
	@echo "ğŸ“„ Todos los resultados se guardarÃ¡n en MetricsGraphics.txt"
	@echo ""
	@# Limpiar archivo anterior
	@rm -f MetricsGraphics.txt
	@echo "=== ANÃLISIS DE ESCALABILIDAD FUERTE - DFA PARALELO ===" > MetricsGraphics.txt
	@echo "Generado el: $$(date)" >> MetricsGraphics.txt
	@echo "Sistema: MPI con comunicaciÃ³n bloqueante y no bloqueante" >> MetricsGraphics.txt
	@echo "DFA: |Q| = 3, |Î£| = 2, acepta strings que contienen \"00\"" >> MetricsGraphics.txt
	@echo "" >> MetricsGraphics.txt
	@# Ejecutar cada configuraciÃ³n
	@$(MAKE) generate-metrics-p1
	@$(MAKE) generate-metrics-p2  
	@$(MAKE) generate-metrics-p4
	@$(MAKE) generate-metrics-p8
	@$(MAKE) generate-metrics-p16
	@$(MAKE) generate-metrics-p32
	@echo ""
	@echo "ğŸ‰ Â¡GeneraciÃ³n completa de mÃ©tricas finalizada!"
	@echo "ğŸ“Š Revisa el archivo MetricsGraphics.txt para ver todos los resultados"
	@echo "ğŸ“ˆ Las mÃ©tricas incluyen: Speedup, Eficiencia, Tiempos de cÃ³mputo y comunicaciÃ³n"

.PHONY: all clean original optimized metrics check-sources run-original run-optimized compare generate-metrics generate-metrics-np generate-metrics-p1 generate-metrics-p2 generate-metrics-p4 generate-metrics-p8 generate-all-metrics 